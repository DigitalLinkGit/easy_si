{# INDEX TABLE COMPONENT #}

{# Initialisation des variables #}
{% set items = items is defined ? items : [] %}
{% set columns = columns is defined ? columns : [] %}
{% set headers = headers is defined ? headers : null %}
{% set table_id = 'table_' ~ random() %}
{% set actions = actions is defined ? actions : {} %}
{% set filter = filter is defined ? filter : false %}
{% set sort = sort is defined ? sort : false %}

{# Bouton Ajouter (hors filtre) #}
	{% if actions.add.route is defined and not filter %}
{% include 'global/components/button/_btn_new.html.twig' with {
		route: actions.add.route,
		params: actions.add.params|default({})
	} %}
{% endif %}


{# Table principale #}
	<table class="table table-hover align-middle" id="{{ table_id }}"> <thead class="table-light">
		<tr>
			{% for header in headers %}
				<th>{{ header }}</th>
			{% endfor %}
			{% if actions.show.route is defined or actions.edit.route is defined or actions.delete.route is defined %}
				<th></th>
			{% endif %}
		</tr>

		{# Ligne de filtres et tris #}
		{% if filter or sort %}
			<tr class="filter-row">
				{% for column in columns %}
					{% set column_index = loop.index0 %}
					<td class="position-relative">
						<div class="d-flex gap-1">
							{% if filter %}
								<input type="text" class="form-control form-control-sm filter" placeholder="Filtrer {{ headers[column_index] ?? column }}" oninput="filterTable(this)" data-filter-column="{{ column_index }}" data-table-id="{{ table_id }}">
							{% endif %}
							{% if sort %}
								<button type="button" class="btn btn-sm" onclick="sortTable('{{ table_id }}', {{ column_index }})" title="Trier cette colonne">
									<i class="bi bi-sort-alpha-down"></i>
								</button>
							{% endif %}
						</div>
					</td>
				{% endfor %}
				{% if actions.show.route is defined or actions.edit.route is defined or actions.delete.route is defined %}
					<td class="table-actions">
						{% if actions.add.route is defined %}
							{% include 'global/components/button/_btn_new.html.twig' with {
								route: actions.add.route,
								params: actions.add.params|default({})
							} %}
						{% endif %}

					</td>
				{% endif %}
			</tr>
		{% endif %}
	</thead>

	<tbody>
		{% for item in items %}
			<tr>
				{# Colonnes dynamiques #}
				{% for property in columns %}
					{% set value = attribute_chain(item, property) %}
					<td>
						{% if value is iterable %}
							{{ value|join(', ') }}
						{% elseif value.value is defined %}
							{{ value.value }}
						{% else %}
							{{ value }}
						{% endif %}
					</td>

				{% endfor %}

				{# Boutons d'action #}
				{% if actions.show.route is defined or actions.edit.route is defined or actions.delete.route is defined %}
					<td
						class="text-nowrap btn-fixed-width">

						{# SHOW #}
						{% if actions.show.route is defined %}
							{% include 'global/components/button/_btn_icon_show.html.twig' with {
								route: actions.show.route,
								params: { id: attribute(item, 'id') }
							} %}
						{% endif %}

						{# EDIT #}
						{% if actions.edit.route is defined %}
							{% include 'global/components/button/_btn_icon_edit.html.twig' with {
								route: actions.edit.route,
								params: { id: attribute(item, 'id') }
							} %}
						{% endif %}

						{# DELETE avec param_map #}
						{% if actions.delete.route is defined %}
							{% set delete_params = {} %}
							{% for key, path in actions.delete.param_map|default({ id: 'id' }) %}
								{% set delete_params = delete_params|merge({ (key): attribute_chain(item, path) }) %}
							{% endfor %}
							{% include 'global/components/button/_btn_icon_delete.html.twig' with {
								route: actions.delete.route,
								params: delete_params
							} %}
						{% endif %}

					</td>
				{% endif %}
			</tr>
		{% else %}
			<tr>
				<td colspan="{{ columns|length + 1 }}" class="text-muted text-center">
					Aucun élément à afficher.
				</td>
			</tr>
		{% endfor %}
	</tbody>
</table>
